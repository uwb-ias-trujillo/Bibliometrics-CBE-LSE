---
title: "CBE-LSE Bibliometric Analysis"
author: "Caleb Trujillo, Darcie Nelson, Rachel Kudlacz, Germaine Ng"
date: "1/31/2022"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("devtools")
require("rgexf")
require("bibliometrix")
require("igraph")
require("tidyverse")
require("xtable")
require("sf")
require("ggrepel")
require("ggraph")
devtools::install_github("massimoaria/bibliometrix")

devtools::install_github("wmurphyrd/fiftystater")
devtools::install_github("UrbanInstitute/urbnmapr")
library(urbnmapr)
library(bibliometrix)
library(tidyverse)
library(networkD3)
library(rgexf)
library(igraph)
library(xtable)
library(readxl)
library(scales)
library(ggplot2)
library("fiftystater")
library(sf)
```

##Introduction

There has tremendous growth in the area undergraduate biology research over the last two decades. This study attempts to summarize and analyze the progress of this growth for the journal of *CBE-LSE*. 

### Summary of initial data set

```{r dataset}
txt <- c("rawdata/CBE-LSE-2010-2021/CBE LSE 2010-2021 1-926.txt")
data <- convert2df(file = txt, dbsource = 'wos', format = "plaintext")
results <- biblioAnalysis(data, sep = ";")

 theme_default <- theme(
    plot.caption = element_text(hjust = 0, face= "italic"),
    plot.title.position = "plot",
    plot.caption.position =  "plot",
    panel.background = element_rect(
      fill = "#F2F2F2"),
    panel.grid = element_line(size = .25, color = "#99CCCC"),
    axis.ticks = element_line(color = "#F2F2F2"),
    legend.key = element_rect(color = "#F2F2F2"),
    legend.background = element_rect(
      fill = "#F2F2F2"),
    legend.position = "top",
    plot.background = element_rect(
      fill = "#F2F2F2")
    )
```

After results are processed, these are stored as data tables for information reporting. 

```{r biblio}
options(width=100)

S <- summary(object = results, pause = FALSE)
S
#plot(x=results, k=10, pause=F)

S$MainInformationDF

dir.create("tables")
write.csv(file = "tables/keywords.csv",as.data.frame(results$ID[1:20]))

write.csv(file = "tables/Maininformation.csv",S$MainInformationDF)

write.csv(file = "tables/ArticlesYears.csv",S$AnnualProduction)

write.csv(file = "tables/MostCitedPapers.csv",S$MostCitedPapers)

write.csv(file = "tables/MostProdAuthors.csv", S$MostProdAuthors)

write.csv(file = "tables/Universities.csv", results$Affiliations)
```
## Research Questions

### Basic overview of the field

```{r overview}
colnames(S$AnnualProduction) <- make.names(colnames(S$AnnualProduction))

ggplot(data = S$AnnualProduction, mapping = aes(x = Year..., y = Articles, group = 1)) +
  geom_line(stat = "identity", color = "#F26E50", size = 1.5)+
  theme_dark()+
  theme_default +
  labs(
    title = "Annual productivity by articles published per year",
    x = NULL,
    y = NULL
  )
ggsave("AnnualProductivity.jpg", device = "jpeg")
xtable(S$MainInformationDF)
```


##Authoring

```{r author productivity}

S$MostProdAuthors 

authors=gsub(","," ",names(results$Authors))
indices <- Hindex(data, field = "author", elements = authors, sep = ";", years = Inf)

indices$H %>%
  dplyr::arrange(desc(NP))

as_tibble(results$Authors)

authordata <- dplyr::inner_join(tibble::as_tibble(results$Authors),indices$H, by = c("AU" = "Element")) %>%
  filter("n" > 5) # only showing authors with at least 5 publications.

authorProdOverTime(data, k = 10, graph = TRUE)$graph + 
  labs(title = "Top authors productivity from 2010 - 2021",x = NULL, y = NULL) +
  theme(legend.position="top") +
  theme_default
  

ggplot(authordata, aes( x = NP, y = h_index)) + 
  geom_point(alpha = 0.6) +
  geom_label_repel(aes(label = AU), size = 2,  box.padding = 0.0001, min.segment.length = Inf)  +
  theme_dark()+
  theme_default +
  labs(y = "h—index", 
       x = "Publications",
       caption = "CBE — Life Science Education") +
  coord_flip()+
  ggtitle("Author productivity", subtitle = "Number of publications and h-index for authors between 2010 and 2021")
```

### Affiliations
```{r affiliations, echo=FALSE}

#Joining files
msidata <- read_excel("rawdata/2020eligibilitymatrix.xlsx", 
    skip = 10)
affiliations <- read_excel("tables/UnivIndex.xlsx")
msiuniv <- left_join(affiliations, msidata) %>%
  filter(OPEID != "NA")

#Tables
msistates <- msiuniv %>%
  group_by(St) %>%
  summarize(n = n(), articles = sum(Freq) ) %>%
  filter(!(St %in% c("DC", "MH", "PR", "VI", "GU"))) %>% 
  rename(states = St, affiliations = n) %>%
  group_by(affiliations, articles)
view(msistates)

msistates$state_name <- state.name[match(msistates$states,state.abb)]

spatial_data <- left_join(msistates,
                          get_urbn_map(map = "states", sf = TRUE),
                          by = "state_name")

#Affiliation Map
affiliationMap <- ggplot() +
  geom_sf(spatial_data,
          mapping = aes(fill = affiliations, geometry = geometry), stat = "sf",
          color = "#ffffff", size = 0.25) +
  labs(fill = "Author affiliations",
       title = "Number of institutions in author affilitations by state",
    x = NULL,
    y = NULL
    ) +
  #scale_fill_gradient(labels = scales::percent) +
  coord_sf(datum = NA) +
  geom_sf_text(data = get_urbn_labels(map = "states", sf = TRUE),
               aes(label = state_abbv),
               size = 3)

affiliationMap +
  theme(plot.margin = unit(c(1,1,1,1), "cm"),
        panel.background = element_blank()) +
  scale_fill_viridis_c(option="E", direction = -1)


#Article Map
articleMap <- ggplot() +
  geom_sf(spatial_data,
          mapping = aes(fill = articles, geometry = geometry), stat = "sf",
          color = "#ffffff", size = 0.25) +
  labs(fill = "Publications",
       title = "Number of articles by state",
    x = NULL,
    y = NULL
    ) +
  #scale_fill_gradient(labels = scales::percent) +
  coord_sf(datum = NA) +
  geom_sf_text(data = get_urbn_labels(map = "states", sf = TRUE), 
               aes(label = state_abbv),
               size = 3) 

articleMap +
  theme(plot.margin = unit(c(1,1.82,1,1), "cm"),
        panel.background = element_blank()) +
  scale_fill_viridis_c(option="E", direction = -1)
```

```{r MSI, echo=FALSE}
msiuniv$`Eligible/ Current Grant` <- as.factor(msiuniv$`Eligible/ Current Grant`)
msieligible <- msiuniv %>%
  group_by(`Eligible/ Current Grant`) %>%
  summarize(n = n())
view(msieligible)

msiuniv$`Type & Control` <- as.factor(msiuniv$`Type & Control`)
msitype <- msiuniv %>%
  group_by(`Type & Control`) %>%
  summarize(n = n())
view(msitype)

temp <- msiuniv %>%
  mutate_if(is.numeric,as.factor)%>%
  mutate_if(is.character,as.factor)%>%
  select(`Institution Name`,`AANAPISI`, `AANAPISI F`,`ANNH`,`ANNH F`,`HBCU`,`HBCU Masters`	, HBGI,HSI,`HSI STEM`,NASNTI, `NASNTI F` ,`PBI F`,`PBI A`,PPOHA,SIP,TCCU) %>%
  pivot_longer(cols = !`Institution Name`) %>%
  mutate(eligibility = if_else(value == 1 | value == 2| value == 3, "Ineligible", "NA")) %>%
  mutate(eligibility = if_else(value == 4 | value == '4R' |value == 5 | value == '5R', "Eligible or potentially eligible", eligibility))%>%
  mutate(eligibility = if_else(value == 6, "Current grantee", eligibility)) %>%
  mutate(eligibility = if_else(value == 0, "Undetermined", eligibility)) %>%
  group_by(name,eligibility)%>%
  summarize(n=n())%>%
  mutate(perc = round(n/sum(n),3))

msisummary_n <- temp%>%
  select(!perc)%>%
  pivot_wider(names_from = name, values_from = c(n))
view(msisummary_n)

msisummary_perc <- temp%>%
  select(!n)%>%
  mutate(perc = label_percent()(perc)) %>% 
  pivot_wider(names_from = name, values_from = c(perc))
view(msisummary_perc)


temp %>%
  filter(eligibility == "Current grantee") %>%
  arrange(perc, "desc") %>% 
  mutate(name = reorder(as.factor(name), desc(perc)), order = (perc)) %>%
  pull(name)-> x_levels

temp$name<- factor(x = temp$name, levels = (x_levels))


MSIAffiliationPlot <- temp %>% 
  filter(#eligibility != "Ineligible" & 
    eligibility != "Undetermined", !is.na(name)) %>%
  ggplot(aes(x = name, y = perc, fill = eligibility)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme_dark()+
  scale_fill_manual(values = c("#F26E50", "#F2A679", "#F2D6B9"))+
  theme_default + 
  labs(
    title = "Author affiliations by Minority Serving Institution status",
    caption = "Percent of the 479 CBE-LSE author affilations found in 2020 US Dept. of Ed. Eligibility Matrix",
    y = NULL, 
    x = NULL
  )  +
  theme(legend.title = element_blank())

MSIAffiliationPlot
  
#mutate(status = if_else(value == TRUE, "Eligible or current grantee",  NA, status ==                     if_else(value == FALSE,"Not eligible or potentially eligible", NA)))
```


### Social Network Analysis (SNA) of co-authorship: What social structures are organizing co-authorship? 
Rachel Kudlacz 
This is the placeholder for the question about the social struction of co-authorship the among the CBE-LSE authors. A social network analysis approach was used...
Text to introduce the script and outputs

```{r co-authorship,echo=FALSE}
#INSERT FUNCTION FOR CREATING DOCUMENT COCITATION NETWORK using 'data' file
# Create a Social Network Analysis(SNA) Network from Co-Citation Network
CoAMatrix <- biblioNetwork(data, analysis = "collaboration", network = "authors", sep = ";")



# Plot the network - look into SNA application
CoANet <- networkPlot(CoAMatrix, 
                      #n = 400,
                      #n = dim(CoAmatrix)[1], 
                      #normalize = "jaccard", 
                      #Title = "Social Network Analysis", 
                     # type = "fruchterman", 
                      #size=0.1, 
                      #remove.multiple=TRUE, 
                      remove.isolates = TRUE,
                      #labelsize = 2, 
                      #weighted = TRUE, 
                      #curved = FALSE, 
                      edgesize = 5, 
                      edges.min = 4,
                      #degree = 5,
                      #label.n = 10,  
                      size.cex = TRUE, 
                      cluster = "louvain"
                      )

ggraph(CoANet$graph, layout = 'fr') +
  geom_edge_link(aes(color = color)) + 
    geom_node_point(aes(color = color, size = deg /100,))+
  geom_node_label(aes(label = label ,color = color, check_overlap = TRUE, repel = TRUE))+
  theme_void() + 
  theme(legend.position = 'none')

write_graph(CoANet$graph,"Gephi files/CBE_LSE_Co-authorshipedge1.graphml", c("graphml"))

```

Text to explain what is shown in the figures.

### What are the collaborative connections between institutions?

Germaine Ng 

This is the placeholder for the question about collaborations between different universities (institutions)
Text to introduce the script and outputs

```{r institution productivity}
Affiliation=results$Affiliations[1:20]
Affiliation

Aff_Freq=results[["Aff_frac"]] %>%
  arrange(desc(Frequency))%>%
  top_n(10)
Aff_Freq

summary(results$Affiliations)
```


```{r collaborative, echo=FALSE}
#INSERT FUNCTION FOR CREATING INSTITUTIONAL NETWORK using 'data' file
#UNdata <- metaTagExtraction(data, Field = "AU_UN", sep = ";")

UniNetMatrix <- biblioNetwork(data, analysis = "collaboration", network = "universities", sep = ";")

# Plot the network

Uninet=networkPlot(UniNetMatrix, n = dim(UniNetMatrix)[1], Title = "Top 20 University Collaborations", type = "auto", size.cex =TRUE, remove.multiple=FALSE, remove.isolates = TRUE, labelsize=0.7,edgesize = 5, edges.min = 3)

plot(Uninet$graph, vertex.label.family = "Helvetica")

head(Uninet$nodeDegree) # Top six universities by degree of publications with other universities
write_graph(Uninet$graph,"Gephi files/CBE_LSE_Universityedge3.graphml", c("graphml"))


Uninet2=networkPlot(UniNetMatrix, n = dim(UniNetMatrix)[1], Title = "Top  University Collaborations", type = "auto", size.cex =TRUE, remove.multiple=FALSE, remove.isolates = TRUE, labelsize=0.7,edgesize = 5, edges.min = 1)

plot(Uninet2$graph, vertex.label.family = "Helvetica")
write_graph(Uninet2$graph,"Gephi files/CBE_LSE_Universityedge1.graphml", c("graphml"))

ggplot((Aff_Freq)) +
         geom_col(aes(x = reorder(Affiliation, Frequency), y = Frequency)) +
  coord_flip() +
  theme_bw()
       
```


### What are the intellectual structures? Document co-citation network and topic analysis

Darcie Nelson
```{r citations, echo=FALSE}
CR <- citations(data, field = "article", sep = ";")
CRtable <-cbind(CR$Cited[1:20])
CRtable

CR2 <- citations(data, field = "article", sep = ";")
CR2table <-cbind(CR2$Cited[1:20])
CR2table

write.csv(file = "Citations.csv",CR2table)

# Sources Table
sourcestable <-cbind(summary(factor(CR$Source))[1:10])
sourcestable

write.csv(file = "Sources.csv",sourcestable)

```

```{r DCA, echo=FALSE, fig.width = 50, fig.asp = .618}

#DOCUMENT COCITATION NETWORK using 'data' file
# Create a co-citation network
DCAMatrix <- biblioNetwork(data, analysis = "co-citation", network = "references", sep = ";")


# Plot the network
DCA = networkPlot(DCAMatrix, n = dim(DCAMatrix)[1], Title = "Co-Citation Network", type = "auto", size.cex = TRUE, remove.multiple=FALSE, labelsize = 10, edgesize = 5, edges.min = 4, label.n = 30, cluster = "louvain", remove.isolates = TRUE, label.cex = TRUE)

plot(DCA$graph, vertex.label.family = "Helvetica")
names(DCA$nodeDegree["american association 2011-1"])<- "AAAS 2011"
noded<-DCA$nodeDegree

write_graph(DCA$graph,"Gephi files/CBE_LSE_DCAedge4.graphml", c("graphml"))
```

```{r bibliographic coupling}

# Group similar documents by references
rownames(data) <- rownames(data)
BC <- biblioNetwork(data, analysis = "coupling", network = "references", sep = ";")

BCnet = networkPlot(BC, n = dim(BC)[1], Title = "Bibliographic Coupling", type = "auto", size.cex = TRUE, remove.multiple=FALSE, labelsize = 1, edgesize = 5, edges.min = 4, label.n = 30, cluster = "louvain", remove.isolates = TRUE, label.cex = TRUE)

ggsave("bibliographiccoupling4.png", plot = BCnet$graph_terms, device = "png")

write_graph(BCnet$graph,"Gephi files/CBE_LSE_BC4.graphml", c("graphml"))
```

```{r topics and keywords}

# Show how key words appear together
CS <- conceptualStructure(data,field ="ID", method = "MCA", minDegree=19, clust= 4 ,k.max=20, stemming=TRUE, labelsize=10, documents=10)

#CS4 <- conceptualStructure(data,field ="ID", method = "MCA", minDegree=6, clust= "auto" ,k.max=20, stemming=TRUE, labelsize=4, documents=10)

ggsave("ConceptualStructure.png", plot = CS$graph_terms, device = "png")
```
