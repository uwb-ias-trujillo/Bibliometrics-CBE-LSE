---
title: "CBE-LSE Bibliometric Analysis"
author: "Caleb Trujillo, Darcie Nelson, Rachel Kudlacz, Germaine Ng"
date: "4/1/2020"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("devtools")
require("rgexf")
require("bibliometrix")
require("igraph")
#devtools::install_github("massimoaria/bibliometrix")
library(bibliometrix)
library(tidyverse)
library(networkD3)
library(rgexf)
library(igraph)
```

##Introduction

There has tremendous growth in the area undergraduate biology research over the last two decades. This study attempts to summarize and analyze the progress of this growth. 

### Summary of initial data set
This is a placeholder for the inital data set
Whole group
```{r dataset}
txt <- c("rawdata/CBE_LSE_2010-2019/20200717_CBE2010-2019-WOS-1-500.txt",
         "rawdata/CBE_LSE_2010-2019/20200717_CBE2010-2019-WOS-501-708.txt")
data <- convert2df(file = txt, dbsource = 'wos', format = "plaintext")
results <- biblioAnalysis(data, sep = ";")
```


```{r biblio}
options(width=100)
S <- summary(object = results, k = 10, pause = FALSE)
S
plot(x=results, k=10, pause=F)

S$MainInformationDF

write.csv(file = "Maininformation.csv",S$MainInformationDF)

write.csv(file = "ArticlesYears.csv",S$AnnualProduction)

write.csv(file = "MostCitedPapers.csv",S$MostCitedPapers)

write.csv(file = "MostProdAuthors.csv", S$MostProdAuthors)
```


##Authoring

```{r author productivity}
authors=gsub(","," ",names(results$Authors)[1:10])

indices <- Hindex(data, field = "author", elements=authors, sep = ";", years = 50)

indices$H

```


## Research Questions

### Social Network Analysis (SNA) of co-authorship: What social structures are organizing co-authorship? 
Rachel Kudlacz 
This is the placeholder for the question about the social struction of co-authorship the among the CBE-LSE authors. A social network analysis approach was used...
Text to introduce the script and outputs
```{r co-authorship,echo=FALSE}
#INSERT FUNCTION FOR CREATING DOCUMENT COCITATION NETWORK using 'data' file
# Create a Social Network Analysis(SNA) Network from Co-Citation Network
CoAMatrix <- biblioNetwork(data, analysis = "collaboration", network = "authors", sep = ";")

# Plot the network - look into SNA application
CoANet <- networkPlot(CoAMatrix, n = dim(CoAMatrix)[1], Title = "Social Network Analysis", type = "auto", size=0.1, remove.multiple=FALSE, labelsize = 1, edgesize = 1, edges.min = 1, label.n = 10, cluster = "louvain", remove.isolates = TRUE)

plot(CoANet$graph, vertex.label.family = "Helvetica")

write_graph(CoANet$graph,"CBE_LSE_Co-authorshipedge1.graphml", c("graphml"))

#CoANet2 <- networkPlot(CoAMatrix, n = dim(CoAMatrix)[1], Title = "Social Network Analysis", type = "auto", size=0.1, remove.multiple=FALSE, labelsize = 1, edgesize = 1, edges.min = 3, label.n = 10, cluster = "louvain", remove.isolates = TRUE)

#plot(CoANet2$graph, vertex.label.family = "Helvetica")

#write_graph(CoANet2$graph,"CBE_LSE_Co-authorshipedge3.graphml", c("graphml"))
```

Text to explain what is shown in the figures.

### What are the collaborative connections between institutions?

Germaine Ng 

This is the placeholder for the question about collaborations between different universities (institutions)
Text to introduce the script and outputs

```{r institution productivity}
Affiliation=results$Affiliations[1:20]
Affiliation

Aff_Freq=results[["Aff_frac"]] %>%
  arrange(desc(Frequency))%>%
  top_n(10)
Aff_Freq
```

```{r collaborative, echo=FALSE}
#INSERT FUNCTION FOR CREATING INSTITUTIONAL NETWORK using 'data' file
#UNdata <- metaTagExtraction(data, Field = "AU_UN", sep = ";")

UniNetMatrix <- biblioNetwork(data, analysis = "collaboration", network = "universities", sep = ";")

# Plot the network

Uninet=networkPlot(UniNetMatrix, n = dim(UniNetMatrix)[1], Title = "Top 20 University Collaborations", type = "auto", size.cex =TRUE, remove.multiple=FALSE, remove.isolates = TRUE, labelsize=0.7,edgesize = 5, edges.min = 3)

plot(Uninet$graph, vertex.label.family = "Helvetica")

head(Uninet$nodeDegree) # Top six universities by degree of publications with other universities
write_graph(Uninet$graph,"CBE_LSE_Universityedge3.graphml", c("graphml"))


Uninet2=networkPlot(UniNetMatrix, n = dim(UniNetMatrix)[1], Title = "Top  University Collaborations", type = "auto", size.cex =TRUE, remove.multiple=FALSE, remove.isolates = TRUE, labelsize=0.7,edgesize = 5, edges.min = 1)

plot(Uninet2$graph, vertex.label.family = "Helvetica")
write_graph(Uninet2$graph,"CBE_LSE_Universityedge1.graphml", c("graphml"))

ggplot((Aff_Freq)) +
         geom_col(aes(x = reorder(Affiliation, Frequency), y = Frequency)) +
  coord_flip() +
  theme_bw()
       
```

### What is the intellectual structures? Document co-citation network and topic analysis

Darcie Nelson
```{r citation}
library(stringdist)
library(stringr)
library(stringi)
library(plyr)
library(dplyr)
library(magrittr)
library(broom)
library(lazyeval)
library(tidyr)
library(reshape2)
#citations

# load functions
  source("cleaningfunctions/citation_functions.R")


# Extract citations from WOS list
    work_data <- as.data.frame(extract_citation(data, "CR"))
    #work_data$label <- as.character(work_data$label)
    work_data$L1<- as.factor(work_data$L1)
    work_data$index<-as.factor( work_data$index)

# Standardize the data--------------------------------------------------------------------
   std_data <- standardize(work_data)

# show authors who are longer than 50 characters
   author_temp <- std_data %>%
        select(authors) %>%
        filter(nchar(authors) > 50)

# clean and standardize author names -----------------------------------------------------

# Run fuzzy match function on a .2 threshold

    #std_data$authorBlock <- fuzzy_match(std_data$authors, .1, std_data$authors)
   
    input_data <- as.character(std_data$authors)
   threshold <- 0.1
    label <- std_data$authors

    # replace NA with a character "NA"
    index <- which(is.na(label))
    label[index] <- "NA"

    index2 <- which(is.na(input_data))
    input_data[index2] <- "NA"

    if(length(input_data) >= 2){

    # compute the similarity match
    jw_dist <- stringdistmatrix(input_data, method = "jw")

    ## use single linkage method as it suits the problem
    hc <- hclust(as.dist(jw_dist), method = 'single')

    plot(hc, labels = input_data)
    #abline(h = threshold, col = "blue")

    ## based on threshold, get clusters and make labels
    cluster <- cutree(hc, h = threshold)

    cluster_labels <- sapply(unique(cluster), function(y) label[min(which(cluster == y))])
    (output_data <- cluster_labels[cluster])

    return(output_data)

    }else{

    return(label)

    }


    # look at author clusters
    author_merges <- std_data %>%
      group_by(authorBlock) %>%
      dplyr::summarise(count = n()) %>%
      filter(count > 15) %>%
      arrange(desc(count))


    # Run the clustering algorithm again to recluster top merge
    # get the top merged author
    name <- author_merges[1, ][[1]]

    std_data2 <- std_data %>%
      filter(authorBlock == name) %>%
      mutate(authorBlock = fuzzy_match(authors, .08, authors))

    std_data3 <- std_data %>%
      filter(authorBlock != name) %>%
      bind_rows(std_data2)

    std_data4 <- std_data3 %>%
      filter(authorBlock == name) %>%
      mutate(authorBlock = fuzzy_match(authors, .05, authors))

    std_data5 <- std_data3 %>%
      filter(authorBlock != name) %>%
      bind_rows(std_data4)

#Add specific criteria for problematic author names
    std_data5$authorBlock[grep("assaraf", std_data5$authorBlock)]


# Run clustering algorithm----------------------------------------------------------------
    books <- std_data5 %>%
        group_by(authorBlock) %>%
        filter(type == "book") %>%
        mutate(mergedLabel = fuzzy_match(documentName, .25, cleanLabel))


    articles <- std_data5 %>%
        group_by(authorBlock, documentYear) %>%
        filter(type == "article") %>%
        mutate(mergedLabel = fuzzy_match(documentName, .15, cleanLabel))

        clean_data <- rbind(books, articles)


# create the flat data file
    flat_data <- clean_data %>%
        mutate( L1 = as.numeric(L1)) %>%
        group_by(L1) %>%
        arrange(mergedLabel) %>%
        do(data.frame(citations = str_c(.$mergedLabel, collapse = "| ")))

# make sure to unwrap this again to check if it was wrapped properly
    flat_data2 <- cbind(data, flat_data[2])


# find the similarity  of the merges------------------------------------------------------

    clean_data <- clean_data %>%
        mutate(jwSimilarity = calc_jw(cleanLabel, mergedLabel))


# plot------------------------------------------------------------------------------------

    merged <- clean_data %>%
        filter(jwSimilarity < 1)


    hist(round(merged$jwSimilarity, 3),
         xlab = "jw similarity distance",
         main = "Freq Merges by similarity distance \n with year and document type boundary")




# save the data------------------------------------------------------------------------------------
    write.csv(clean_data, "WOS_nodeList.csv", row.names = FALSE)
    write.csv(flat_data2, "WOS_clean.csv", row.names = FALSE)

CR <- citations(data, field = "article", sep = ";")
CRtable <-cbind(CR$Cited[1:20])

write.csv(file = "Citations.csv",CRtable)

sourcestable <-cbind(summary(factor(CR$Source))
[1:10])

write.csv(file = "Sources",sourcestable)

    
    
```

```{r DCA, echo=FALSE, fig.width = 50, fig.asp = .618}

#DOCUMENT COCITATION NETWORK using 'data' file
# Create a co-citation network
DCAMatrix <- biblioNetwork(data, analysis = "co-citation", network = "references", sep = ";")

DCAMatrix <- biblioNetwork(data, analysis = "co-citation", network = "references", sep = ";")

# Plot the network
DCA = networkPlot(DCAMatrix, n = dim(DCAMatrix)[1], Title = "Co-Citation Network", type = "auto", size.cex = TRUE, remove.multiple=FALSE, labelsize = 10, edgesize = 5, edges.min = 4, label.n = 30, cluster = "louvain", remove.isolates = TRUE, label.cex = TRUE)

plot(DCA$graph, vertex.label.family = "Helvetica")
names(DCA$nodeDegree["american association 2011-1"])<- "AAAS 2011"
noded<-DCA$nodeDegree

write_graph(DCA$graph,"CBE_LSE_DCAedge4.graphml", c("graphml"))

DCA2 = networkPlot(DCAMatrix, n = dim(DCAMatrix)[1], Title = "Co-Citation Network", type = "auto", size.cex = TRUE, remove.multiple=FALSE, labelsize = 10, edgesize = 5, edges.min = 2, label.n = 30, cluster = "louvain", remove.isolates = TRUE, label.cex = TRUE)

plot(DCA2$graph, vertex.label.family = "Helvetica")
names(DCA2$nodeDegree["american association 2011-1"])<- "AAAS 2011"

write_graph(DCA2$graph,"CBE_LSE_DCAedge2.graphml", c("graphml"))
```

