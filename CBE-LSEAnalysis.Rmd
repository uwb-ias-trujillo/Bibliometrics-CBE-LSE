---
title: "CBE-LSE Bibliometric Analysis"
author: "Caleb Trujillo, Darcie Nelson, Rachel Kudlacz, Germaine Ng"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#require("devtools")

#devtools::install_github("massimoaria/bibliometrix")
devtools::install_github("wmurphyrd/fiftystater")
devtools::install_github("UrbanInstitute/urbnmapr")

library(urbnmapr)
#library(bibliometrix)
library("fiftystater")

pacman::p_load(tidyverse,
readxl,
networkD3,
rcartocolor,
rgexf,
igraph,
xtable,
scales,
ggplot2,
sf,
ggthemes,
ggpubr,
ggrepel,
RColorBrewer,
bibliometrix,
ggtext,
ggforce,
PupillometryR
)

source('functions.r')
```

## Introduction

There has been tremendous growth in the area of undergraduate biology research over the last fifteen years. This study attempts to summarize and analyze the progress of this growth for the journal of *CBE-LSE*. 

### Summary of initial data set

```{r dataset, skip = TRUE}
txt <- c("rawdata/CBE-LSE-2008-June2022/CBE-LSE-2008-June2022.txt")
data <- convert2df(file = txt, dbsource = 'wos', format = "plaintext") 

results <- biblioAnalysis(data, sep = ";")

authorformat <- function(x){
  str_replace(
      str_to_title(x),"[a-zA-Z]+$",
      str_to_upper(str_extract(x,"[a-zA-Z]+$")
      ))
  }

theme_default <- theme(
  text = element_text(color = "#444444", size = 12),
  axis.title = element_text(size = 16, color = "#555555"),
  plot.caption = element_text(hjust = 0, face= "italic"),
  #major.grid.y = element_line(color = "#BBBBBB", size = 0.2),
  plot.title.position = "plot",
  plot.caption.position = "plot",
  panel.background = element_rect(fill = "white"),
  panel.grid = element_line(size = .25, color = "grey60"),
  axis.ticks = element_blank(),
  legend.key = element_rect(color = "#F2F2F2"),
  legend.background = element_rect(fill = "white"),
  legend.position = "top",
  plot.background = element_rect(fill = "white")
  )
```

After the results are processed, they are stored as data tables for information reporting. 

```{r biblio, include = FALSE, skip = TRUE}
options(width=100)

S <- summary(object = results, pause = FALSE)
dir.create("tables")
write.csv(file = "tables/keywords.csv",as.data.frame(results$ID[1:20]))

write.csv(file = "tables/Maininformation.csv",S$MainInformationDF)

write.csv(file = "tables/ArticlesYears.csv",S$AnnualProduction)

write.csv(file = "tables/MostCitedPapers.csv",S$MostCitedPapers)

write.csv(file = "tables/MostProdAuthors.csv", S$MostProdAuthors)

write.csv(file = "tables/Universities.csv", results$Affiliations)

write.csv(file = "tables/Data.csv", data)
```

```{r main information summary, echo=FALSE}
as.data.frame(S$MainInformationDF)
```
# Research Questions

### Basic overview of the field

A timeline of the publication productivity is included for the journal.

```{r overview, skip = TRUE}
colnames(S$AnnualProduction) <- c("Year","Articles")
edrline<-112
AnnualProduction <- S$AnnualProduction %>%
  mutate(Indexed = "Indexed") %>%
  filter(Year != 2022) %>%
  rbind( data.frame(Year = c(2021,2022), 
                    Indexed = "Projected", 
                    Articles = c(74,40 + 25 + 20))
         ) %>%
  mutate(col = case_when(Indexed == "Indexed" ~ "#266b6e",
                         Indexed == "Projected" ~ "#1d4f60",))

prodplot <- ggplot(data = AnnualProduction, 
                 mapping = aes(x = Year, 
                               y = Articles, 
                               group = Indexed, 
                               color = Indexed, linetype = Indexed)) +
  geom_line(data = AnnualProduction,
            aes(x = Year, y= edrline+2),
            color = "white", size = 13) +  
  geom_line(stat = "identity", 
            size = 1.5) +
  geom_line(data = AnnualProduction,
            aes(x = Year, y= edrline),
            color = "#444444", alpha = 0.4) +
  geom_line(data = AnnualProduction %>% filter(Year %in% c(2010:2020)), 
            aes(x = Year, y= edrline),
            color = "#444444") +
  geom_text(data = AnnualProduction %>% filter(Year %in% c(2010,2020)), 
             aes(x = Year, y= edrline),
             color = "#444444", label = "â–¶", family = "HiraKakuPro-W3", size = 3) +
   # geom_text(data = AnnualProduction %>% filter(Year %in% c(2008)),
   #          aes(x = Year, y= edrline, label = "Eds:"),
   #          color = "#444444",
   #          hjust = "left",
   #          vjust = "middle",
   #          nudge_x = -0.2) +
  geom_label(data = AnnualProduction %>% filter(Year %in% c(2008)), 
            aes(x = Year, y= edrline, label = "Wood"), 
            color = "#444444", 
            hjust = "left", 
            vjust = "middle",
            nudge_x = -0.2) +
  geom_label(data = AnnualProduction %>% filter(Year %in% c(2010)), 
            aes(x = Year, y= edrline, label = "Dolan"), 
            color = "#444444", 
            hjust = "left", vjust = "middle",
            nudge_x = 0.2) +
  geom_label(data = AnnualProduction %>% filter(Year %in% c(2020)), 
            aes(x = Year, y= edrline , label = "Schinske,\nTanner", color = "#444444"), 
            color = "#444444", hjust = "left", 
            vjust = "middle", nudge_x = 0.2, nudge_y = -3) +
  geom_text_repel(data = AnnualProduction %>% filter(Year %in% c(2010, 2016)), 
                  aes(x = Year, y= Articles, label = c(Articles)), 
                  min.segment.length = 1, vjust = "middle", 
                  hjust =1, box.padding = 0.1) +
  geom_text_repel(data = AnnualProduction %>% filter(Year %in% c(2011, 2015)), 
                  aes(x = Year, y= Articles, label = c(Articles)), 
                  min.segment.length = 1, vjust = "top", 
                  hjust = "right", box.padding = 0, 
                  nudge_x = 0, nudge_y = 0) +
    geom_text_repel(data = AnnualProduction %>% filter(Year %in% c(2013)), 
                  aes(x = Year, y= Articles, label = c(Articles)), 
                  min.segment.length = 1, vjust = "top", 
                  hjust = "right", box.padding = 0.4, 
                  #nudge_x = 0, 
                  nudge_y = 4
                  #vjust = "middle", 
                  #hjust =1
                  ) +
  geom_text(data = AnnualProduction %>% filter(Year %in% c(2022), 
                                               Indexed == "Projected"), 
            aes(x = Year, y= Articles, 
                label = "85"), 
            vjust = 0, hjust = 1, nudge_y = 2) +
  #geom_line(data = data.frame(x = as.factor(c(2021,2022)), y = c(74,40 + 25 + 20)), aes(x,y), linetype = 6, stat = "identity", color = "266b6e", # "#1d4f60", size = 1, alpha = 0.8) + # added projected Documents.
  scale_x_discrete(breaks = function(x){x[if_else(x == 2010 |x == 2015 | x == 2020, TRUE,FALSE,)]})+
  scale_y_continuous(limits = c(40,116)) +
  theme_default +
  scale_color_manual(values= c("#5881b7","#29456B")) +
   guides(Indexed = guide_legend("Published documents"))+
  theme(#panel.grid.major.x = element_blank(),
        panel.grid.minor.y =  element_blank(),
        panel.grid.major.y = element_line(size = 0.2, color = "#BBBBBB"),
        axis.text.x = element_text(hjust = 0),
         legend.position = "none")+
  labs(
    #title = "A. Journal productivity",
    title = "A.",
    # subtitle = "Editors-in-Chief and the documents published per year",
    x = NULL,
    y = NULL,
  )
prodplot

# ggsave("figures/AnnualProductivity.jpg", plot = prodplot,
#        device = "jpeg", dpi = 400, bg = "white",
#        width = 7, height = 4, units = "in", limitsize = FALSE)


```


## Authoring

We focused on the most productive authors within the data set by H-index. 
```{r author productivity}
S$MostProdAuthors 
k_authors <- 13
authors <- gsub(","," ",names(results$Authors))
indices <- Hindex(data, field = "author", elements = authors, sep = ";", years = Inf)

authortopH<- indices$H %>%
  dplyr::arrange(desc(h_index)) %>%
  select(Element,h_index) %>%
  top_n(k_authors)

#as_tibble(results$Authors)

authordata <- dplyr::inner_join(tibble::as_tibble(results$Authors),indices$H, by = c("AU" = "Element")) %>%
  filter("n" > 5)# %>%
  #only showing authors with at least 5 publications.

M <- data
M$TC <- as.numeric(M$TC)
M$PY <- as.numeric(M$PY)
M <- M[!is.na(M$PY), ]
Y <- as.numeric(substr(Sys.time(), 1, 4))
listAU <- (strsplit(M$AU, ";"))
nAU <- lengths(listAU)

df <- data.frame(AU = trimws(unlist(listAU)), SR = rep(M$SR,nAU))
AU <- df %>% group_by(.data$AU) %>% 
  count() %>% 
  full_join(authortopH, by = c("AU" = "Element")) %>%
  arrange(desc(.data$h_index)) %>% 
  ungroup()
k <- min(k_authors, nrow(AU))
AU <- AU %>% slice_head(n = k)
AU$case <- str_replace(
  str_to_title(AU$AU),
  "[a-zA-Z]+$",
  str_to_upper(
    str_extract(
      AU$AU,"[a-zA-Z]+$")
    ))

AU$case <- str_c(AU$case, ", ",AU$h_index)
  
df <- df %>% right_join(AU, by = "AU") %>% left_join(M, by = "SR") %>% 
    select(.data$AU.x, .data$PY, .data$TI, .data$SO, .data$DI, .data$TC) %>% 
    mutate(TCpY = .data$TC/(Y - .data$PY + 1)) %>% 
    group_by(.data$AU.x) %>% 
    mutate(n = length(.data$AU.x)) %>% 
    ungroup() %>% 
    rename(Author = .data$AU.x, year = .data$PY, DOI = .data$DI) %>% 
    arrange(desc(.data$n), desc(.data$year)) %>% 
    select(-.data$n)

df2 <- dplyr::group_by(df, .data$Author, .data$year) %>% 
    dplyr::summarise(freq = length(.data$year), TC = sum(.data$TC), TCpY = sum(.data$TCpY)) %>% 
    as.data.frame()



AU2 <- df2 %>% group_by(Author) %>% summarise(medianY = median(year)) %>% full_join(AU, by = c("Author" = "AU"))
AU2$case<-fct_reorder(AU2$case,
                        #AU2$medianY,
                        AU2$h_index,
                        .desc = TRUE)
  
levels(df2$Author) <- levels(AU2$case)
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 0.125)
data("logo", envir = environment())
logo <- grid::rasterGrob(logo, interpolate = TRUE)

authordatacheck<-df2%>%group_by(Author)%>%summarise(n = sum(freq))

#df2

hindexcheck<- df %>% 
  group_by(Author) %>%
  arrange(desc(TC)) %>%
  summarise(h_index = sum(TC >= seq_along(TC)))

# authordatacheck%>%
#   left_join(hindexcheck)%>%
#   view()
```

We display a timeline of the productive authors.


```{r author productivity figure}
table(df$Author,df$year)
articlesbyyear <- as.data.frame(table(df$Author,df$year))
colnames(articlesbyyear) <- c("Author","year","freq")

sumauthor<- df %>%
  left_join(authortopH, by = c("Author" = "Element")) %>%
  group_by(h_index,Author,year) %>%
  summarize(freq = n(), totalTCpY = sum(TCpY)) %>%
  arrange(h_index) %>%
  #mutate(Author = as.factor(Author)) %>%
  mutate(Author = fct_reorder(Author, h_index)) %>%
  mutate(label = str_c(Author,h_index,sep = " "))

# sumauthor$Author
# view(sumauthor)

authorprod <- sumauthor %>%
  ggplot(aes(x = Author, y = year, size = freq, alpha = totalTCpY)) +
  geom_line(color ="#994E95", size = 1, alpha = 0.4) +
  geom_point(fill =  "#FFFFFF", color ="#FFFFFF", alpha = 1)+ 
  #geom_text(aes(label = h_index, size = 2),color = "#444444",alpha = 1, check_overlap = TRUE, group = 1, y = 2007)+
  geom_point(fill =  "#994E95", color ="#994E95")+ 
     scale_size(range = c(2, 5), 
                breaks = c(1,3,5,7)) + 
     scale_alpha(range = c(0.3, 1), 
                 breaks =  c(0,20,40,60)) + 
    scale_y_continuous(breaks = c(2010,2015,2020), limits = c(2008, 2022)) +
    guides(size = guide_legend(order = 1, "Documents"),
           alpha = guide_legend(order = 2, "Times cited"),
           nrow = 1
           ) + 
  #geom_text(df, mapping = aes(x = .data$Author, y = .data$year, group =  .data$Author)) +
  theme_default+
    theme(#legend.position = c(.4,-0.05),
      legend.position = "right",
          #legend.direction	= "horizontal",
          legend.title = element_text(),
          #legend.box="horizontal",
          axis.title.y = ggtext::element_markdown(vjust = 0, angle = 0, hjust = 0),
          axis.text.x = element_text(
                                     hjust = 0, #x_nudge = -0.5
                                     ),
          axis.text.y = element_text(
                                   margin = margin(r = -0.05, l = 0.3, unit = "in"),
                                   hjust = 1),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          #panel.grid.major.y = element_line(size = 0.2),
          panel.grid.major.y = element_blank(),
          panel.spacing = unit(0.01, "cm"),
          #plot.margin = margin(t = 1, r = 1, b = 10, l = 0, unit = "pt"),
        #panel.grid.major.x = element_line(size = 0.2),
        plot.title.position = "plot", legend.margin=margin(),
         #plot.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"),
        plot.subtitle = ggtext::element_markdown(),
        strip.text.y.left = element_text(angle = 00, vjust = 1, size =  10, color = "#444444"),
        strip.background = element_blank(),
        strip.switch.pad.grid = unit(0.01, "cm"),
        strip.placement = "outside"
)+
            #guides(fill=guide_legend(nrow = 2 ,byrow = TRUE)) + 
    labs(#title = "B. Author productivity", 
         title = "B.", 
         #subtitle =paste("Documents authored per year and ordered by Hirch (h) index"),
         x = NULL, y = NULL) +
  facet_grid(rows = vars(h_index), 
             shrink = TRUE,
             scales = "free", 
             space = "free", 
             switch = "y", as.table =  FALSE)+
    scale_x_discrete(labels = authorformat) + 
  coord_flip()

authorprod

# ggsave("figures/AuthorProd.jpg", 
#        device = "jpeg", dpi = 400, bg = "white",
#        width = 7, height = 4.5, units = "in", limitsize = FALSE)
```

```{r combing journal and author figure}
ggarrange(prodplot,
          authorprod,
          ncol	=1,
          heights = c(1.3,1.8),
          widths = c(1.3,1.8),
          align = "v"#,
          #common.legend = TRUE
          )

ggsave("figures/Prodcommon.jpg", 
       device = "jpeg", dpi = 400, bg = "white",
       width = 6,
       height = 8, 
       units = "in", 
       limitsize = FALSE)

ggsave("figures/Prodcommon.eps", 
       device = "eps", dpi = 300, bg = "white",
       width = 17.57,
       height = 13.1775, 
       units = "cm", 
       limitsize = FALSE)
```


```{r author other, eval=FALSE, skip = TRUE}
# authordata %>%
#   mutate(AU = str_replace(
#     str_to_title(AU),
#     "[a-zA-Z]+$",
#     str_to_upper(
#       str_extract(
#         AU,"[a-zA-Z]+$")
#       ))) %>%
#   filter(n > 8) %>%
#   ggplot(aes(x = reorder(AU, (NP)), y = NP)) +
#     geom_col(fill =  "#994E95", alpha = 0.9) +
#     #geom_label_repel(aes(label = AU), size = 2, box.padding = 0.001, min.segment.length = 0.01)  +
#     #theme_minimal()+
#     theme_default +
#     labs(y = NULL,
#          x = NULL,
#          caption = "CBE â€” Life Science Education between 2010 and 2021") +
#     coord_flip() +
#     theme(#axis.text.y = element_text(size = 8),
#           panel.grid.major.y = element_blank(),
#           #panel.grid.major.x = element_blank(),
#           #panel.grid.minor.x = element_blank(),
#           panel.background = element_rect(fill = "#FFFFFF"),
#           axis.title = element_text(size = 14, color = "#555555"), 
#           axis.title.y = element_text(vjust = 1, angle = 0, hjust = 0), 
#           axis.text.x = element_text(
#                                      hjust = 0
#                                      ),
#           axis.text.y = element_text(size = 8,
#                                     margin = margin(r = -0.05, l = 0.1, unit = "in"),
#                                     hjust = 1,),
#           legend.position = 'none') +
#     ggtitle("Author productivity", subtitle = "Number of publications by LSE authors")

# Add color for school type using the other graph to depict these. 
# Going to use full join between data on author productivity and their affiliation (university or institution). 
```


## Institutions
### Affiliations around the world

# ```{r world corresponding author affiliations, echo=FALSE}
# world_map = map_data("world") %>% 
#   filter(long < 180)
# 
# countries <- world_map %>% 
#   distinct(region) %>% 
#   rowid_to_column()
# 
# allcountries <- data.frame(countries = countries$region, count = NA)
# 
# for (country in countries$region) {
#   allcountries[countries == country] <- sum(str_count(data$C1,str_to_upper(country)),na.rm = TRUE)
# }
# 
# countryfreq <- results$Countries %>%
#   as.data.frame() %>%
#   mutate(Tab = str_to_title(Tab)) %>% 
#   mutate(Tab = case_when(
#     Tab == "Usa" ~ "USA",
#     Tab == "United Kingdom" ~"UK",
#     TRUE ~ Tab
#   )) 
# 
# 
#   
# countryfreq <- allcountries %>% 
#   filter(count > 0) %>%
#   mutate(region = countries) %>%
#    full_join(countryfreq,by = c("region" = "Tab")) %>%
#   mutate(coor_author_freq = Freq, Freq = count, Tab = region)
# 
# world_map_short <- world_map %>%
#   full_join(countryfreq, by = c("region" = "Tab")) %>%
#   filter(Freq >= 1 & (subregion != "Alaska" | region != "New Zealand"))#%>%
#   #mutate(case_when(region == "USA", ))
# 
# worldcentroids <- world_map_short %>%
#   group_by(region, Freq) %>%
#   filter(subregion != "Alaska" & subregion != "Pitt Island" & subregion != "Chatham Island" & subregion != "12"& subregion != "13") %>%
#   summarise(latitude = sign(lat) * exp(mean(log(abs(lat)))), longitude = sign(long) * exp(mean(log(abs(long)))))
# 
# 
# AffiliationWorldMap <- countries %>%
#   full_join(countryfreq, by = c("region" = "region")) %>% 
#   ggplot(aes(fill = Freq, map_id = region), color = 1) +
#   #geom_hline(yintercept=0, color = "light grey") +
#   geom_map(map = world_map_short, colour = "white", lwd = 0.2) +
#   geom_map(map = world_map, colour = "light grey", lwd = 0.2)+
#   geom_point(data = worldcentroids, aes(x = longitude, y = latitude, size = Freq*100, group = region),color = "#333333") +
#     geom_text(data = worldcentroids, aes(x = longitude, y = latitude, label = Freq, size = Freq, group = region), color = "white") +
#   expand_limits(x = world_map_short$long, y = world_map_short$lat) +
#   coord_map("moll") +
#   #coord_quickmap()+
#   #theme_map()+
#   theme_default +
#   #labs(caption = "") +
#   theme(#plot.margin= unit(c(0.5, 0.5, 0.5, 0.5), "cm"),
#         # plot.caption = element_text(hjust = 0, face= "italic"),
#         axis.title = element_text(size = 14, color = "#555555"),
#          plot.title.position = "plot",
#          plot.caption.position =  "plot",
#         legend.title = element_blank(),
#         #panel.background = element_rect(fill = "aliceblue", color = "aliceblue"),
#         legend.position = c(0.5, 0.01),
#         legend.background = element_rect(fill = NA),
#         legend.direction = "horizontal",
#         #legend.key.size = unit(0.4, "cm"),
#         legend.key.height= unit(.5, 'cm'),
#         legend.key.width= unit(.5, 'cm'),
#         panel.border = element_blank(),
#         panel.grid = element_blank(),
#         plot.background = element_blank()
#         #plot.caption.position = "plot",
#         #plot.caption = element_text(hjust = 0)
#         #legend.margin = margin(6, 12, 4, 1)
#         #legend.position = "none"
#         ) +
#   scale_fill_carto_c(palette = "BluGrn", direction = 1,
#                        # trans = scales::pseudo_log_trans(sigma = 0.01),
#                        # breaks = c(1,10, 100, 1000),
#                        # labels = c(1,10, 100, 1000),
#                        # limits = c(1,1000)
#   ) +
#   scale_size(range = c(3,14))+
#   labs(fill = "Count of article",
#        title = "A. Published  by country",
#        
#     x = NULL,
#     y = NULL
#     ) 
# 
# AffiliationWorldMap
# 
# ggsave("figures/AffiliationWorldMapshort.jpg", device = "jpeg", dpi = 400,  width = 7,
#   height = 3,
#   units = "in", limitsize = FALSE)
# ```


```{r world all author affiliations, echo=FALSE}
world_map = map_data("world") %>%
  filter(long < 180)

countries <- world_map %>%
  distinct(region) %>%
  rowid_to_column()

allcountries <- data.frame(countries = countries$region, count = NA)
#countries <- countries %>% mutate(region = str_c(region,"."))

for (country in countries$region) {
  allcountries[countries == country] <- sum(str_count(data$C1,str_to_upper(country)),na.rm = TRUE)
}

countryfreq <- results$Countries %>%
  as.data.frame() %>%
  mutate(Tab = str_to_title(Tab)) %>%
  mutate(Tab = case_when(
    Tab == "Usa" ~ "USA",
    Tab == "United Kingdom" ~"UK",
    TRUE ~ Tab
  ))

allcountries <- allcountries %>%
  mutate(region = countries) %>%
  filter(region != "Georgia")

All_world_map_short <- world_map %>%
  full_join(countryfreq, by = c("region" = "Tab")) %>%
  full_join(allcountries, by = c("region" = "region")) %>%
  filter(Freq >= 1 & (subregion != "Alaska" | region != "New Zealand"))#%>%
  #mutate(case_when(region == "USA", ))


All_worldcentroids <- All_world_map_short %>%
  group_by(region, count, Freq) %>%
  filter(subregion != "Alaska" & subregion != "Pitt Island" ) %>%
#& subregion != "Chatham Island" & subregion != "12"& subregion != "13") %>%
  summarise(latitude = sign(lat) * exp(mean(log(abs(lat)))), longitude = sign(long) * exp(mean(log(abs(long))))) %>%
  group_by(region, count,Freq, latitude, longitude)%>%
  summarise() %>%
  group_by(region, count, Freq) %>% 
  slice_head(n = 1) %>%
  filter(count >0 )

AllAffiliationWorldMap <- allcountries %>%
  full_join(countryfreq, by = c("region" = "Tab")) %>%
  ggplot(aes(fill = count, map_id = region), color = 1) +
  #geom_hline(yintercept=0, color = "light grey") +
  geom_map(map = All_world_map_short, colour = "white", lwd = 0.2) +
  geom_map(map = world_map, colour = "light grey", lwd = 0.2)+
  geom_autopoint(data = All_worldcentroids %>% group_by(region, Freq), aes(x = longitude, y = latitude, size = Freq*150, group = region,),color = "#333333") +
    geom_text(data = All_worldcentroids, aes(x = longitude, y = latitude, label = Freq, size = Freq, group = region), color = "white") +
  expand_limits(x = All_world_map_short$long, y = All_world_map_short$lat) +
  #coord_quickmap()+
  theme_map()+
  #theme_default +
  #labs(caption = "") +
  theme(#plot.margin= unit(c(0.5, 0.5, 0.5, 0.5), "cm"),
        # plot.caption = element_text(hjust = 0, face= "italic"),
        axis.title = element_text(size = 14, color = "#555555"),
         plot.title.position = "plot",
         plot.caption.position =  "plot",
        legend.title = element_blank(),
        #panel.background = element_rect(fill = "aliceblue", color = "aliceblue"),
        legend.position = c(0.5, 0.01),
        legend.background = element_rect(fill = NA),
        legend.direction = "horizontal",
        #legend.key.size = unit(0.4, "cm"),
        legend.key.height= unit(.5, 'cm'),
        legend.key.width= unit(.5, 'cm'),
        #plot.caption.position = "plot",
        #plot.caption = element_text(hjust = 0)
        #legend.margin = margin(6, 12, 4, 1)
        #legend.position = "none",
        panel.border = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank()
        #legend.position = "top"
        ) +
  scale_fill_carto_c(palette = "BluGrn", direction = 1,
                     trans = scales::pseudo_log_trans(sigma = 0.01),
                        breaks = c(1,10, 100, 1000, 5000),
                        labels = c(1,10, 100, 1000, 5000),
                        limits = c(1, 5000)
  ) +
  scale_size(range = c(3,14))

AllAffiliationWorldMapWest <- AllAffiliationWorldMap +
  coord_map("ortho", orientation = c(10, -90, 0)) +
  labs(fill = "Count of co-authors",
       title = "A.",
    x = NULL,
    y = NULL
    ) 

AllAffiliationWorldMapCenter<- AllAffiliationWorldMap+
  coord_map("ortho", orientation = c(10, 20, 0)) +
  labs(#caption = "NE: 2. Source: Web of Science",
    title = "",
    x = NULL,
    y = NULL
    ) 

AllAffiliationWorldMapEast <- AllAffiliationWorldMap+
  coord_map("ortho", orientation = c(-10, 110, 0)) +
  labs(#caption = "NE: 2. Source: Web of Science",
    title = "",
    x = NULL,
    y = NULL
    ) 

AllAffiliationWorldMapWest
AllAffiliationWorldMapCenter
AllAffiliationWorldMapEast

# ggsave("figures/AllAffiliationWorldMapshort.jpg", device = "jpeg", dpi = 400,  width = 7,
#   height = 3,
#   units = "in", limitsize = FALSE)
```

### Affiliations in the US

```{r US affiliations}
#Affiliation Map - US
#Joining files
msidata <- read_excel("rawdata/2020eligibilitymatrix.xlsx", 
    skip = 10)

affiliations <- read_excel("tables/UnivIndex.xlsx")

msiuniv <- left_join(affiliations, msidata) %>%
  filter(OPEID != "NA")

dplyr::anti_join(affiliations, msidata)
#Tables
msistates <- msiuniv %>%
  group_by(St) %>%
  summarize(n = n(), articles = sum(Freq) ) %>%
  #filter(!(St %in% c("MH", "PR", "VI", "GU"))) %>% 
  rename(states = St, affiliations = n) %>%
  group_by(affiliations, articles) %>%
  drop_na()

msistates$state_name <- state.name[match(msistates$states,state.abb)]

#corrstates <- data.frame(states = msistates$states, count = NA)
# for (istates in msistates$states) {
#   corrstates[states == istates] <- sum(str_count(data$RP,istates),na.rm = TRUE)
# }
# 
# corrstates <- msistates %>% 
#   right_join()
#   
us <- fortify(map_data("state"), region = "region") %>%
  mutate(region = str_to_title(region))
spatial_data <- right_join(msistates,
                          us,
                          by = c("state_name" ="region"))

affiliationMap <- ggplot() +
  geom_map(data  =  spatial_data, map = us,
             aes(x = long, y = lat, map_id = state_name, group = group, fill = affiliations, label = states),
             color = "#444444", size = 0.25) +
  coord_map("albers", lat0 = 39, lat1 = 45) +
  theme_map() +
  theme_default +
  scale_fill_viridis_c(option = "E", 
                       direction = -1)+
  labs(fill = "Author affiliations",
       title = "A. Author affilitations by state",
       x = NULL,
       y = NULL) +
  theme(plot.margin = unit(c(1,1,1,1), "cm"),
        panel.background = element_blank())

# ggsave("figures/AffiliationUSMap.jpg", device = "jpeg", dpi = 400,  #width = 7,
#   #height = 5,
#   units = "in", limitsize = FALSE)


centroids <- spatial_data %>%
  group_by(state_name, articles) %>%
    filter(!(states == "RI")) %>% 
  summarise(latitude = exp(mean(log(lat))), longitude = -exp(mean(log(abs(long))))) %>%
  inner_join(msistates)

#Article Map 
ArticlesUSMap <- ggplot() +
  geom_map(data  =  spatial_data, map = us,
           aes(x = long, y = lat, map_id = state_name, group = group, fill = articles, label = states),
             color = "white", size = 0.25) +
  geom_point(data = centroids, aes(x = longitude, y = latitude, size = articles*130), color = "#333333") +
    geom_text(data = centroids, aes(x = longitude, y = latitude, label = articles, size = articles*0.8), color = "white") +
  coord_map("moll") +
  theme_map() +
  labs(fill = "Publications",
       title = "B.",
       #caption = "DC: 23, PR: 11, HI: 6, AK: 3, VI: 2, GU: 1, MH: 1.\nCounts are summarized by state/territory of each article by each author's affiliation.",
       caption = "RI: 12, DC: 23, PR: 11, HI: 6, AK: 3, VI: 2, GU: 1, MH: 1",
    x = NULL,
    y = NULL
    ) +
  scale_fill_carto_c(palette = "BluGrn", direction = 1) +
  scale_size(range = c(3,14))+
  theme_default+
  theme(#plot.margin = unit(c(-2,0,0,0), "cm"),
        panel.background = element_blank(),
        legend.background = element_blank(),
        legend.direction = "vertical",
        legend.title=element_blank(),
        legend.key.height= unit(.5, 'cm'),
        legend.key.width= unit(.5, 'cm'),
        plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0),
        legend.position = c(.8, 0.01),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank()
        #legend.position = "top"
        )+
  scale_fill_carto_c(palette = "BluGrn", direction = 1,
                       # trans = scales::pseudo_log_trans(sigma = 0.01),
                       # breaks = c(1,10, 100, 1000),
                       # labels = c(1,10, 100, 1000),
                       # limits = c(1,1000)
                     )

ArticlesUSMap
# ggsave("figures/ArticlesUSMap.jpg",
#        device = "jpeg", dpi = 400,
#        width = 7, height = 4,
#        units = "in", limitsize = FALSE)
```

```{r combining maps}
world<- ggarrange(AllAffiliationWorldMapWest,
AllAffiliationWorldMapCenter,
AllAffiliationWorldMapEast, legend = "none", ncol = 3, nrow =1)

ggarrange(world,ArticlesUSMap,common.legend = TRUE, 
          legend = "none", 
          #legend = "bottom",
          ncol = 1, nrow =2, heights =  c(1,1.1),#widths = c(3,1), 
          align = c("v")
)
ggsave("figures/MapCombo.jpg",
       device = "jpeg", dpi = 400,
       width = 7, height = 8,
       units = "in", bg = "white", limitsize = FALSE)

```

```{r MSI, echo=FALSE}
msiuniv$`Eligible/ Current Grant` <- as.factor(msiuniv$`Eligible/ Current Grant`)

msieligible <- msiuniv %>%
  group_by(`Eligible/ Current Grant`) %>%
  summarize(n = n())

msiuniv$`Type & Control` <- as.factor(msiuniv$`Type & Control`)

msitype <- msiuniv %>%
  group_by(`Type & Control`) %>%
  summarize(n = n()) %>%
  mutate(percent = (n/sum(n)))

msitypeall <- msidata %>%
  group_by(`Type & Control`) %>%
  summarize(n = n()) %>%
  mutate(percent = (n/sum(n)))

types <- left_join(msitypeall,msitype, by = "Type & Control")
colnames(types)<- c("SchoolType", "Number of Insitutions in US", "US", "Number of Institutes in LSE", "LSE")
types$SchoolType <- recode(types$SchoolType, "Pri 2yr" = "Private 2-year", "Pri 4yr" = "Private 4-year","Pub 2yr" = "Public 2-year", "Pub 4yr" = "Public 4-year") 
types$SchoolType <- factor(types$SchoolType, 
                           levels=c("Public 4-year",
                                    "Private 4-year",
                                    "Public 2-year",
                                    "Private 2-year"))


#view(types)

#We try to compare the percentage breakdown of institutions in the US according to the MSI eligibility matrix to amount in the LSE affiliations list.

#Public

SchoolTypeTable <- types %>%
  pivot_longer(!SchoolType) %>%
  filter(name == "US" | name == "LSE") %>%
  filter(SchoolType != FALSE) %>%
  mutate(colorlevel = case_when(
      name == "US" ~ 1,
      name == "LSE" ~ 0.96)) %>%
  mutate(Control = case_when( 
    str_detect(SchoolType, "Private") ~ "Private",
    str_detect(SchoolType, "Public") ~ "Public"
    ),
    Control = as.factor(Control),
    Type = case_when( 
      str_detect(SchoolType, "2") ~ "2-Yr",
      str_detect(SchoolType, "4") ~ "4-Yr"),
    Sign = case_when( 
      str_detect(name, "US") ~ 1,
      str_detect(name, "LSE") ~ 1),
    name = case_when( 
      str_detect(name, "US") ~ "U.S.",
      TRUE ~ name),
      Type = as.factor(Type))
  
SchoolTypePlot <- ggplot(SchoolTypeTable,aes(x = SchoolType, value * Sign ,fill = SchoolType
             )) +
    # geom_col(fill = "white",
    #            #position = "stack",
    #            size = 4,
    #          label = vars(SchoolType)) +
  geom_col(aes(label = Type, #alpha = as.numeric(colorlevel)
               ),
               #position = "stack",
               size = 4) +
  geom_hline(yintercept = 0, color = "#BBBBBB")+
    # geom_text(aes(label = Type, y =0 ),
    #           #vjust = 0.5,
    #           #nudge_x = .4,
    #           position = position_stack(vjust = 0.),
    #           size = 3, fontface = "bold") +a
    # geom_label_repel(aes(label = SchoolType),
    #           #vjust = 0.5,
    #           box.padding = 0.5,
    #           point.padding = 0.8,
    #           direction = "y",
    #           #position = position_stack(vjust = 0.5),
    #           #nudge_y = -.015,
    #           size = 3, fontface = "bold") +
  geom_text_repel(aes(y = value * Sign ,label = paste0(round(value*100,0),"%")),
              #position = position_fill(vjust = Sign),
              #nudge_y = -.015,
              #hjust = 0.5,
            size = 3, fontface = "bold", 
            direction = "x"
            ) +
  scale_color_identity(guide = "none") +
  scale_fill_brewer(palette = "Paired")+
  scale_alpha_binned(range = c(1.5,0.5)) +
  scale_y_continuous(breaks = NULL,
    # minor_breaks = NULL,
    #                  labels = scales::percent,
    #                  breaks = c(0,0.4,.8)
                     ) +
  labs(x = NULL, y = NULL,
       #title = "B. Author-affiliated school types compared to U.S. distribution",
       title = "B."
       ) +
  coord_flip()+
   facet_grid(cols =vars(name), scales = "free", as.table = TRUE, 
              #nrow = 4, ncol = 1,
  #            #strip.position = "left",
  #            #dir = "h",
  #            switch = "x"
              )+
  theme_default +
  theme(panel.spacing.y = unit(1, "lines"),
        axis.title.x = element_text(face = c("italic")),
        axis.text.y = element_text(size = 10,
                                   margin = margin(l = 0.2, unit = "in")
                                   ),
        strip.text.x = element_text(size = 11, 
                                    angle = 0),
        strip.text.y = element_text(angle = 0),
        strip.background = element_rect(fill = "#F2F2F2"),
        panel.grid = element_blank(),
        #plot.margin = margin(t = .25, r = .25, b = .25, l = .1, unit = "in"),
        strip.placement = "outside",
        legend.position = "none")
SchoolTypePlot
# ggsave("figures/SchoolTypes.jpg", device = "jpeg", dpi = 400,  width = 7,
#   height = 5,
#   units = "in", limitsize = FALSE)
```


```{r MSI cont}
msiuniv2 <- msiuniv %>%
  mutate_if(is.numeric,as.factor)%>%
  mutate_if(is.character,as.factor)%>%
  select(`Institution Name`,`AANAPISI`, `AANAPISI F`,`ANNH`,`ANNH F`,`HBCU`,`HBCU Masters`, HBGI,HSI,`HSI STEM`,NASNTI, `NASNTI F` ,`PBI F`,`PBI A`,PPOHA,SIP,TCCU, MSEIP) %>%
  pivot_longer(cols = !`Institution Name`) %>%
  mutate(eligibility = if_else(value == 1 | value == 2| value == 3, "Ineligible", "NA")) %>%
  mutate(eligibility = if_else(value == 4 | value == '4R' |value == 5 | value == '5R', "Eligible or potentially eligible", eligibility))%>%
  mutate(eligibility = if_else(value == 6, "Current grantee", eligibility)) %>%
  mutate(eligibility = if_else(value == 0, "Undetermined", eligibility)) 

temp <- msiuniv2 %>% 
  group_by(name,eligibility)%>%
  summarize(n=n())%>%
  mutate(perc = round(n/sum(n),3)) %>%
  mutate(titled = case_when(
    name %in% c("AANAPISI F","ANNH F","HBCU Masters","PPOHA","HSI STEM", "NASNTI F","PBI F","PBI A","SIP","MSEIP") ~ TRUE,
    TRUE ~ FALSE))

msisummary_n <- temp%>%
  select(!perc)%>%
  pivot_wider(names_from = name, values_from = c(n))

msisummary_perc <- temp%>%
  select(!n)%>%
  drop_na()%>%
  #mutate(perc = label_percent()(perc)) %>% 
  pivot_wider(names_from = name, values_from = c(perc))
#view(msisummary_perc)

temp$name<- factor(temp$name, levels = c("SIP","HBCU Masters", "TCCU","AANAPISI", "PBI A", "ANNH","ANNH F","PBI F","PPOHA","AANAPISI F", "HBGI","HBCU" ,"MSEIP","HSI STEM","HSI"))

MSIAffiliationPlot <- temp %>% 
  filter(eligibility == "Current grantee",
    # eligibility != "Undetermined", 
    # eligibility == "Ineligible",
    name %in% c("TCCU", "ANNH", "HBGI","HBCU","HSI", "AANAPISI", "PBI A"),
    #eligibility != "Ineligible", 
    !is.na(name)) %>%
  ggplot(aes(x = name, y = perc)) +
  geom_col(position = position_stack(reverse = TRUE),  fill = "#4da284") +
  geom_text(
    aes(label = n
          #perc * 100,
          ),
    hjust = 0 , nudge_y = .0005,
    size = 3.5, fontface = "bold"
  ) +
  scale_y_continuous(labels = scales::percent, 
                     #limits = c(0,1)
                     ) +
  coord_flip() +
  #facet_grid(rows = vars(titleIII), scales = "free", space = "free")+
  theme_default + 
  labs(
    #title = "C. US author affiliations by Minority Serving Institution status",
    title = "C.",
    y = NULL, 
    x = NULL,
    #caption = "Current grantee status in 2020 U.S. Dept. of Ed."
  )  +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(size = 0.1),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(margin = margin(r = -0.5, l = 0.4, unit = "cm")),
        strip.text.y =  element_blank()
       )

MSIAffiliationPlot
# ggsave("figures/MsiAffiliations.jpg",
#        device = "jpeg", dpi = 400,
#        width = 7, height = 4,
#        units = "in", limitsize = FALSE)
```


```{r MSI supplement cont}
MSIAffiliationPlotSupp <- temp %>% 
  filter(eligibility != "Undetermined",
    !is.na(name)) %>%
  ggplot(aes(x = name, y = perc, fill = eligibility)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0,1)
                     ) +
  coord_flip() +
  facet_grid(rows = vars(titleIII), scales = "free", space = "free")+
  scale_fill_manual(values = c("#266b6e", "#4da284", "#c4e6c3"
                               )) +
  theme_default + 
  labs(
    title = "LSE author affiliations in the US by Minority Serving Institution status",
    y = NULL, 
    x = NULL
  )  +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(margin = margin(r = -0.5, l = 0.4, unit = "cm")),
        strip.text.y =  element_blank()
       )

MSIAffiliationPlotSupp
ggsave("figures/MsiAffiliationsSupp.jpg",
       device = "jpeg", dpi = 400,
       width = 7, height = 4,
       units = "in", limitsize = FALSE)

msiuniv %>%
  mutate_if(is.numeric,as.factor)%>%
  mutate_if(is.character,as.factor)%>%
  select(`Institution Name`,`AANAPISI`, `AANAPISI F`,`ANNH`,`ANNH F`,`HBCU`,`HBCU Masters`, HBGI,HSI,`HSI STEM`,NASNTI, `NASNTI F` ,`PBI F`,`PBI A`,PPOHA,SIP,TCCU) %>%
  pivot_longer(cols = !`Institution Name`) %>%
  mutate(eligibility = if_else(value == 1 | value == 2| value == 3, "Ineligible", "NA")) %>%
  mutate(eligibility = if_else(value == 4 | value == '4R' |value == 5 | value == '5R', "Eligible or potentially eligible", eligibility))%>%
  mutate(eligibility = if_else(value == 6, "Current grantee", eligibility)) %>%
  mutate(eligibility = if_else(value == 0, "Undetermined", eligibility)) %>%
  group_by(eligibility, `Institution Name`) %>%
  #summarise(n = n(),sum = sum(n))%>%
  unique()
    #summarise(total = sum(sum))

msisummary_n %>% filter(eligibility == "Current grantee", titleIII) %>% 
  #select(!titleIII) %>%
  t()


msiuniv2 %>% 
  group_by(`Institution Name`,eligibility)

eligibilitysummary <- msiuniv2 %>%
  filter(name != 'SIP') %>%
  select(`Institution Name`,eligibility) %>%
  group_by(`Institution Name`,eligibility) %>%
  summarise(n = n()) 

USinstEligibleCount<- eligibilitysummary%>%
  filter(eligibility != 'Ineligible' & eligibility != 'Undetermined') %>%
  select(`Institution Name`) %>%
  unique() %>% 
  nrow()

USinstGranteeCount<- eligibilitysummary%>%
  filter(eligibility != 'Ineligible' & eligibility != 'Undetermined'  & eligibility != 'Eligible or potentially eligible') %>%
  select(`Institution Name`) %>%
  unique() %>% 
  nrow()

USinstCount<-eligibilitysummary %>%
  select(`Institution Name`) %>%
  unique() %>% nrow()

PercentEligible <- USinstEligibleCount / USinstCount
GranteeEligible <- USinstGranteeCount / USinstCount

PercentEligible
GranteeEligible

table(msidata$`Eligible/ Current Grant`)
```

### What are the collaborative connections between institutions?

```{r top 10 affiliations}
Affiliation <- results$Affiliations[1:10]
Affiliation <- as.data.frame(Affiliation) %>%
  mutate(
    color = case_when(
      row_number() == 1 ~ "#CFB87C",
      row_number() == 2 ~ "#18453B",
      row_number() == 3 ~ "#C5050C",
      row_number() == 4 ~ "#BA0C2F",
      row_number() == 5 ~ "#4b2e83",
      row_number() == 6 ~ "#8C1D40",
      row_number() == 7 ~ "#231161",
      row_number() == 8 ~ "#2774AE",
      row_number() == 9 ~ "#7a0019",
      row_number() == 10 ~ "#a51417",
      ## all others should be gray
      TRUE ~ "#6dbc90"
    ))

#Author affiliations
AuAffiliationPlot<- ggplot(Affiliation,aes(x = reorder(str_to_title(AFF), Freq), y = Freq)) +
  geom_col(aes(fill = color)) +
  geom_col(aes(fill = "white"), alpha = 0.7) +
  geom_col(aes(y =5, fill = color)) +
  geom_text(
    aes(label = reorder(str_to_title(AFF), Freq), y=0.13),
    hjust = 0, nudge_y = 6,
    size = 3.5, fontface = "bold",
    fill = "white", label.size = 0, color="black"
  ) +
  geom_text(
    aes(label = Freq),
    hjust = 0, nudge_y = .5,
    size = 3.5, fontface = "bold"
  ) +
  coord_flip() +
  theme_default +
  labs(
    x = NULL,
    y = NULL,
    #title = "A. Top affiliations of authors",
    title = "A.",
    # caption = "Source: Web of Science"
  )+
  scale_fill_identity(guide = "none") +
  scale_x_discrete(labels = NULL)+ 
  scale_y_continuous(labels = NULL)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = 'none',
        )

# ggsave("figures/AffiliationsTopAuthors.jpg",
#        device = "jpeg", dpi = 400,
#        width = 7, height = 4,
#        units = "in", limitsize = FALSE)


ggarrange(AuAffiliationPlot, SchoolTypePlot, MSIAffiliationPlot, ncol = 1, nrow = 3, common.legend = FALSE, align = c("v"))

ggsave("figures/AffiliationsCombo.jpg",
       device = "jpeg", dpi = 400,
       width = 7, height = 8,
       units = "in", bg = "white", limitsize = FALSE)
```

### Most cited papers and journals
```{r citations, echo=FALSE}
CR <- citations(data, field = "article", sep = ";")
CRtable <-cbind(CR$Cited[1:20])
#CRtable

write.csv(file = "Citations.csv",CRtable)

# Sources Table
sourcestable <-cbind(summary(factor(CR$Source))[1:10])
#sourcestable

write.csv(file = "Sources.csv",sourcestable)
```



### Multiple Correspondence Analysis

```{r conceptual structure with keywords}
# Show how key words appear together using Multiple Correspondence Analysis
#Consider selecting only articles that have the keywords  associated 
# CS30 <- bibliometrix::conceptualStructure(data, 
#                           field ="TI", 
#                           ngrams = 1, 
#                           method = "MCA", 
#                           minDegree= 30,
#                           clust= "3", 
#                           k.max=5, 
#                           stemming= TRUE, 
#                           labelsize=10, 
#                           documents=10
#                           )

# CS16AB <- bibliometrix::conceptualStructure(data,
#                           field = "AB",
#                           ngrams = c(1),
#                           method = "MCA",
#                           minDegree= 16,
#                           #clust= "3",
#                           #k.max=5,
#                           stemming= TRUE,
#                           labelsize=10,
#                           documents=10
#                           )


CS20 <- bibliometrix::conceptualStructure(data, 
                          field ="ID", 
                          ngrams = c(1,2,3,4), 
                          method = "MCA", 
                          minDegree= 20,
                          clust= "3", 
                          k.max=5, 
                          #quali.supp = "PY",
                          stemming= TRUE, 
                          labelsize=10, 
                          documents=3
                          )

CS30 <- bibliometrix::conceptualStructure(data,
                          field ="ID",
                          ngrams = c(1,2,3,4),
                          method = "MCA",
                          minDegree= 30,
                          clust= "4",
                          k.max=5,
                          stemming= TRUE,
                          labelsize=10,
                          documents=10
                          )

CS20$graph_terms+
  theme_default + 
  labs(title = "") +
  theme(legend.position = "none", axis.text = element_text(size = 14))
ggsave("figures/20ConceptualStructure.png", device = "png")

CS20$graph_dendogram +
  theme_default+ 
    labs(title = "") +
  theme(legend.position = "none", axis.text = element_text(size = 14))
ggsave("figures/20ConceptualCluster.png", device = "png")

CS30$graph_terms+
  theme_default + 
  labs(title = "") +
  theme(legend.position = "none", axis.text = element_text(size = 14))
ggsave("figures/30ConceptualStructure.png", device = "png")

CS30$graph_dendogram +
  theme_default+ 
    labs(title = "") +
  theme(legend.position = "none", axis.text = element_text(size = 14))
ggsave("figures/30ConceptualCluster.png", device = "png")

# ggsave("figures/CS30ConceptualStructure.png", plot = CS30$graph_terms, device = "png")
# 
# ggsave("figures/CS30ConceptualCluster.png", plot = CS30$graph_dendogram + coord_flip(), device = "png")

# ggsave("figures/CS30ConceptualStructure.png", plot = CS30$graph_terms, device = "png")
# 
# ggsave("figures/CS30ConceptualCluster.png", plot = CS30$graph_dendogram + coord_flip(), device = "png")
```


```{r conceptual structure with keywords at 15}
# 
# CS15 <- #termExtraction(data, "TI",stemming = TRUE, keep.terms = compound) %>%
#   bibliometrix::conceptualStructure(data,
#                           field = c("ID"), 
#                           ngrams = c(1,2,3), 
#                           method = "MCA", 
#                           minDegree= 15,
#                           #clust= "3", 
#                           k.max=5, 
#                           stemming= TRUE, 
#                           labelsize=10, 
#                           documents=10
#                           )
# ggsave("figures/15ConceptualStructure.png", plot = CS15$graph_terms, device = "png")
# 
# ggsave("figures/15ConceptualCluster.png", plot = CS15$graph_dendogram + coord_flip(), device = "png")
```


```{r title topics}
hypened<-results$ID[results$ID>10] %>%
  row.names()%>%
  str_detect("-") 
spaced<- results$ID[results$ID>10] %>%
  row.names()%>%
  str_detect(" ")
compound<-results$ID[results$ID>10][hypened|spaced]%>%
  row.names()

compound <- compound[!compound %in% "UNDERGRADUATE RESEARCH EXPERIENCES"]
  
TitleTerms <- termExtraction(data, "TI",stemming = TRUE, keep.terms = compound) %>%
  KeywordGrowth(Tag= "TI_TM", top = 1000) %>%
  pivot_longer(cols = !c('Year')) %>%
  group_by(Year) %>%
  mutate(sum = sum(value), perc = value / sum) %>%
  filter(value > 1) %>%
  filter(perc > 0.005)

SharedTerms <- TitleTerms %>%
  #select(Year,name) %>%
  group_by(name) %>%
  summarize(total = n()) %>%
  filter(total > 2)

TopTerms<- TitleTerms %>% 
  filter(name %in% SharedTerms$name) %>%
  group_by(Year) %>%
  arrange(value, .by_group = TRUE) #%>%
  #top_n(15)

TitleText <- TitleTerms %>%
  group_by(name) %>%
  top_n(1, Year) %>%
  filter(name %in% SharedTerms$name)

clustername <- as.data.frame(CS20[["km.res"]]$cluster)
colnames(clustername) <-c("cluster")
clustername$name <- row.names(clustername)
clustername$name <- str_to_upper(clustername$name)

TitleTerms %>% 
  filter(name %in% TopTerms$name) %>%
  left_join(clustername)%>%
  group_by(cluster) %>%
  arrange(value, .by_group = TRUE) %>%
  top_n(5) %>%
  ggplot(aes(Year, perc, color=as.factor(cluster), #group = cluster, 
             fill=name, label = name))+
  geom_smooth() + 
  geom_text_repel(aes(label = name), data = . %>% group_by(name) %>% top_n(1, Year), 
                  size = 2, 
                  color = "black",
                  arrow = arrow(length = unit(0.02, "npc")),
                  box.padding = 0.5
                  ) +
  scale_y_log10(labels = label_percent()) + 
  theme_default +
  labs(title = "Conceptual trends based on article titles")+
  theme(legend.position="none")

TitleTerms %>% 
  filter(name %in% TopTerms$name) %>%
  left_join(clustername)%>%
  group_by(cluster) %>%
  arrange(value, .by_group = TRUE) %>%
  #top_n(5) %>%
  ggplot(aes(Year, perc, color=as.factor(cluster), fill=name, label = name))+
  geom_line() + 
  geom_text_repel(aes(label = name), data = . %>% group_by(name) %>% top_n(1, Year), 
                  size = 2, 
                  color = "black",
                  arrow = arrow(length = unit(0.02, "npc")),
                  box.padding = 0.5
                  ) +
  scale_y_log10(labels = label_percent()) + 
  theme_default +
  labs(title = "Conceptual trends based on article titles")+
  theme(legend.position="none")

# ggsave("figures/TitleLineTrends.png", device = "png", dpi = 400,
#        width = 7, height = 7,
#        units = "in")
```


```{r title topics horizontal plot}
TitleTerms %>% 
  filter(name %in% TopTerms$name) %>%
  ggplot(aes(x=reorder(as.factor(str_to_sentence(name)),cumsum(value)),y = Year, group = name, color=name, fill=name, label = name, size = perc), alpha = 0.3)+
  #geom_violin(alpha = 0.3)+
  #geom_point() +
  #geom_line(alpha = 0.8, size = 0.5)+
  geom_violin(aes(scale = perc))+
  geom_text(aes(label = str_to_sentence(name)), data = . %>% group_by(name) %>% top_n(-1, Year), #%>% filter(Year > 2012), 
                  size = 2, 
                  color = "black",
                  #arrow = arrow(length = unit(0.02, "npc")),
                  #box.padding = 0.5
                  nudge_x = 0,hjust = -0)+
  scale_y_continuous(labels = label_date(format = "%y")) +
  scale_x_discrete()+
  coord_flip ()+
  theme_default +
  labs(title = "Conceptual trends based on article titles", y = NULL, x = NULL, )+
  theme(legend.position="none",
        axis.text.y = element_blank())

# ggsave("figures/TitleTrends.png", width = 4, height = 7, device = "png")
```


```{r conceptual structure with titles, skip = TRUE, eval = FALSE, echo = FALSE}
# CS2 <- termExtraction(data, "TI",stemming = FALSE, keep.terms = compound) %>%
#   conceptualStructure(field ="TI_TM", 
#                           ngrams = 1, 
#                           method = "MCA",
#                           quali.supp = NULL,
#                           quanti.supp = NULL,
#                           minDegree= 50,
#                           clust= "auto", 
#                           k.max=5, 
#                           stemming= FALSE, 
#                           labelsize=10, 
#                           documents=2)
# 
# ggsave("figures/ConceptualStructure2.png", plot = CS2$graph_terms, device = "png")
# 
# 
# ggsave("figures/ConceptualCluster2.png", plot = CS2$graph_dendogram + coord_flip(), device = "png")
```
